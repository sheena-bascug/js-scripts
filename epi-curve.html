<style>
</style>

<script
    src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
    crossorigin="anonymous"></script>

<script type="text/javascript">

    const continents = {
        "Africa": ["Algeria", "Angola", "Benin", "Botswana", "Burkina Faso", "Burundi", "Cabo Verde", "Cameroon", "Central African Republic", "Chad", "Comoros", "Congo", 
            "Côte d'Ivoire", "Djibouti", "DR Congo", "Egypt", "Equatorial Guinea", "Eritrea", "Eswatini", "Ethiopia", "Gabon", "Gambia", "Ghana", "Guinea", "Guinea-Bissau", 
            "Kenya", "Lesotho", "Liberia", "Libya", "Madagascar", "Malawi", "Mali", "Mauritania", "Mauritius", "Morocco", "Mozambique", "Namibia", "Niger", "Nigeria", 
            "Rwanda", "Sao Tome & Principe", "Senegal", "Seychelles", "Sierra Leone", "Somalia", "South Africa", "South Sudan", "Sudan", "Tanzania", "Togo", "Tunisia", 
            "Uganda", "Zambia", "Zimbabwe"],
        "Asia": ["Afghanistan", "Armenia", "Azerbaijan", "Bahrain", "Bangladesh", "Bhutan", "Brunei ", "Cambodia", "China", "Cyprus", "Georgia", "India", "Indonesia", 
            "Iran", "Iraq", "Israel", "Japan", "Jordan", "Kazakhstan", "Kuwait", "Kyrgyzstan", "Laos", "Lebanon", "Malaysia", "Maldives", "Mongolia", "Myanmar", "Nepal",
            "North Korea", "Oman", "Pakistan", "Philippines", "Qatar", "Saudi Arabia", "Singapore", "South Korea", "Sri Lanka", "State of Palestine", "Syria", 
            "Tajikistan", "Thailand", "Timor-Leste", "Turkey", "Turkmenistan", "United Arab Emirates", "Uzbekistan", "Vietnam", "Yemen"],
        "Americas": ["Anguilla", "Antigua and Barbuda", "Argentina", "Aruba", "Bahamas", "Barbados", "Belize", "Bermuda", "Bolivia", "Brazil", "British Virgin Islands", 
            "Canada", "Caribbean Netherlands", "Cayman Islands", "Chile", "Colombia", "Costa Rica", "Cuba", "Curaçao", "Dominica", "Dominican Republic", "Ecuador", 
            "El Salvador", "Falkland Islands", "French Guiana", "Grenada", "Guadeloupe", "Guatemala", "Guyana", "Haiti", "Honduras", "Jamaica", "Martinique", "Mexico", 
            "Montserrat", "Nicaragua", "Panama", "Paraguay", "Peru", "Puerto Rico", "Saint Kitts and Nevis", "Saint Lucia", "Saint Martin", "Saint Pierre and Miquelon", 
            "Saint Vincent - Grenadines", "Saint-Barthélemy", "Sint Maarten", "Suriname", "Trinidad and Tobago", "Turks and Caicos Islands", "United States of America", 
            "United States Virgin Islands", "Uruguay", "Venezuela"],
        "Europe": ["Albania", "Andorra", "Austria", "Belarus", "Belgium", "Bosnia and Herzegovina", "Bulgaria", "Croatia", "Czech Republic", "Denmark", 
            "Estonia", "Finland", "France", "Germany", "Greece", "Holy See", "Hungary", "Iceland", "Ireland", "Italy", "Latvia", "Liechtenstein", "Lithuania", 
            "Luxembourg", "Malta", "Moldova", "Monaco", "Montenegro", "Netherlands", "North Macedonia", "Norway", "Poland", "Portugal", "Romania", "Russian Federation", 
            "San Marino", "Serbia", "Slovakia", "Slovenia", "Spain", "Sweden", "Switzerland", "Ukraine", "United Kingdom"],
        "Oceania": ["Australia", "Papua New Guinea", "New Zealand", "Fiji", "Solomon Islands", "Vanuatu", "Samoa", "Kiribati", "Micronesia", "Tonga", 
            "Marshall Islands", "Palau", "Tuvalu", "Nauru"],
        "Other": []

    };
    var isHealthy = true;
    var features = [];
    
    var settings = {
        "url": "https://services.arcgis.com/5T5nSi527N4F7luB/ArcGIS/rest/services/Historic_adm0_v3/FeatureServer/0/query",
        "method": "POST",
        "timeout": 0,
        "headers": {
        "Content-Type": "application/x-www-form-urlencoded"
        },
        "data": {
        "f": "json",
        "where": "1=1",
        "outFields": "OBJECTID, DateOfDataEntry, cum_conf, NewCase, ADM0_VIZ_NAME",
        "returnGeometry": "false",
        "spatialRel": "esriSpatialRelIntersects",
        "orderByFields": "DateOfDataEntry asc",
        "resultOffset": "0",
        "cacheHint": "true"
        }
    };

    // https://stackoverflow.com/questions/14446511/most-efficient-method-to-groupby-on-an-array-of-objects
    // https://gist.github.com/robmathers/1830ce09695f759bf2c4df15c29dd22d
    var groupByDate = function (data, key) {

        return data.reduce(function(storage, item) {
            var group = (new Date(item[key])).toLocaleDateString();

            storage[group] = storage[group] || [];
            storage[group].push(item);

            return storage;
        }, {});
    };

    $.ajax(settings).done(function (response) {
        var result = JSON.parse(response);
        var entries = [];

        result.features.forEach(entry => {
            var newEntry = entry.attributes;
            
            entries.push(newEntry);

        });

        var entriesByDate = groupByDate(entries, "DateOfDataEntry");

        console.log(entriesByDate);

    });

    
    // agol health check: https://developers.arcgis.com/rest/services-reference/health-check.htm

</script>